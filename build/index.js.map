{
  "version": 3,
  "file": "index.js",
  "sourceRoot": "../src/",
  "sources": [
    "index.coffee"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "'use strict'\r\nMongoClient = require 'mongodb'\r\n.MongoClient\r\nObjectId = require 'mongodb'\r\n.ObjectId\r\nasync = require 'async'\r\nminimatch = require 'minimatch'\r\ncrypto = require 'crypto'\r\ncryptojs = require 'crypto-js'\r\nalgorithm = 'aes-256-ctr'\r\nobjtrans = require 'objtrans'\r\nsettings = require './settings'\r\ns = require('underscore.string')\r\nDeepDiff = require 'deep-diff'\r\n.diff\r\nversion = require('../package.json').version\r\ndatabase = null\r\nndx = {}\r\nmaintenanceMode = false\r\nuseEncryption = false\r\nencryptIgnore = ['**._id']\r\ncallbacks =\r\n  ready: []\r\n  insert: []\r\n  update: []\r\n  select: []\r\n  delete: []\r\n  preInsert: []\r\n  preUpdate: []\r\n  preSelect: []\r\n  preDelete: []\r\n  selectTransform: []\r\n  serverSelectTransform: []\r\n  restore: []\r\nsyncCallback = (name, obj, cb) ->\r\n  if callbacks[name] and callbacks[name].length\r\n    for callback in callbacks[name]\r\n      callback obj\r\n  cb?()\r\nasyncCallback = (name, obj, cb) ->\r\n  truth = false\r\n  if callbacks[name] and callbacks[name].length\r\n    async.eachSeries callbacks[name], (cbitem, callback) ->\r\n      cbitem obj, (result) ->\r\n        truth = truth or result\r\n        callback()\r\n    , ->\r\n      cb? truth\r\n  else\r\n    cb? true\r\nencryptString = (str) ->\r\n  if str\r\n    return cryptojs.AES.encrypt(str, (settings.ENCRYPTION_KEY or settings.SESSION_SECRET)).toString()\r\n  return null\r\ndecryptString = (str) ->\r\n  if str\r\n    return cryptojs.AES.decrypt(str, (settings.ENCRYPTION_KEY or settings.SESSION_SECRET)).toString(cryptojs.enc.Utf8)\r\n  return ''\r\nencryptObj = (obj, path) ->\r\n  myobj = {}\r\n  for ignore in encryptIgnore\r\n    if minimatch path, ignore\r\n      return obj\r\n  type = Object.prototype.toString.call obj\r\n  if type is '[object Object]'\r\n    for key of obj\r\n      myobj[key] = encryptObj obj[key], \"#{path}.#{key}\"\r\n  else if type is '[object Boolean]'\r\n    return obj\r\n  else\r\n    return encryptString JSON.stringify obj\r\n  myobj\r\ndecryptObj = (obj, path) ->\r\n  for ignore in encryptIgnore\r\n    if minimatch path, ignore\r\n      return obj\r\n  type = Object.prototype.toString.call obj\r\n  if type is '[object Object]'\r\n    for key of obj\r\n      obj[key] = decryptObj obj[key], \"#{path}.#{key}\"\r\n  else if type is '[object Boolean]'\r\n    return obj\r\n  else\r\n    if not obj\r\n      return obj\r\n    return JSON.parse decryptString obj\r\n  obj\r\nencryptWhere = (obj, path) ->\r\n  type = Object.prototype.toString.call obj\r\n  for ignore in encryptIgnore\r\n    if minimatch path, ignore\r\n      return obj\r\n  if type is '[object Object]'\r\n    for key of obj\r\n      mypath = path\r\n      if key.indexOf('$') isnt 0\r\n        mypath = \"#{path}.#{key}\"\r\n      obj[key] = encryptWhere obj[key], mypath\r\n  else if type is '[object Boolean]'\r\n    return obj\r\n  else\r\n    return encryptString JSON.stringify obj\r\n  obj\r\ncleanObj = (obj) ->\r\n  for key of obj\r\n    if key.indexOf('$') is 0 or key is '#'\r\n      delete obj[key]\r\n    else if Object.prototype.toString.call(obj[key]) is '[object Object]'\r\n      cleanObj obj[key]\r\n  return\r\nreadDiffs = (from, to, out) ->\r\n  diffs = DeepDiff from, to\r\n  out = out or {}\r\n  for dif in diffs\r\n    switch dif.kind\r\n      when 'E', 'N'\r\n        myout = out\r\n        mypath = dif.path.join('.')\r\n        good = true\r\n        if dif.lhs and dif.rhs and typeof(dif.lhs) isnt typeof(dif.rhs)\r\n          if dif.lhs.toString() is dif.rhs.toString()\r\n            good = false\r\n        if good\r\n          myout[mypath] ={}\r\n          myout = myout[mypath]\r\n          myout.from = dif.lhs\r\n          myout.to = dif.rhs\r\n  out\r\nunpack = (diffs, out) ->\r\n  out = out or {}\r\n  for key of diffs\r\n    bits = key.split /\\./g\r\n    myout = out\r\n    for bit, i in bits\r\n      if not myout[bit]\r\n        if i < bits.length - 1\r\n          myout[bit] = {}\r\n        else\r\n          myout[bit] = diffs[key]\r\n      myout = myout[bit]\r\n  out\r\nconvertWhere = (where) ->\r\n  walk = (base, current, route) ->\r\n    if current and current.hasOwnProperty('$like')\r\n      current.$regex = \".*#{current.$like or ''}.*\"\r\n      current.$options = 'i'\r\n      delete current.$like\r\n    for key of current\r\n      obj = current[key]\r\n      type = Object.prototype.toString.call obj\r\n      if type is '[object Object]'\r\n        if key.indexOf('$') is 0\r\n          walk obj, obj, ''\r\n        else\r\n          newroute = route\r\n          if newroute\r\n            newroute += '.'\r\n          newroute += key\r\n          walk current, obj, newroute\r\n      else if type is '[object Array]'\r\n        if obj.length and Object.prototype.toString.call(obj[0]) is '[object Object]'\r\n          for item in obj\r\n            item = walk item, item, ''\r\n      else\r\n        if key.indexOf('$') is 0\r\n          base[route][key] = obj\r\n        else if route\r\n          newroute = route + '.' + key\r\n          base[newroute] = obj\r\n          delete base[newroute.split(/\\./g)[0]]\r\n        else\r\n          if key is '_id' or newroute is '_id'\r\n            obj = new ObjectId obj\r\n          base[key] = obj\r\n  walk where, where, ''\r\n  delete where['#']\r\n  where\r\nselect = (table, args, cb, isServer) ->\r\n  new Promise (resolve, reject) ->\r\n    if ndx.cache && cacheResult = ndx.cache.get table, args, ndx.user\r\n      resolve cacheResults.output\r\n      return cb? cacheResult.output, cacheResult.total\r\n    ((user) ->\r\n      asyncCallback (if isServer then 'serverPreSelect' else 'preSelect'), \r\n        pre: true\r\n        table: table\r\n        args: args\r\n        user: user\r\n      , (result) ->\r\n        if not result\r\n          resolve []\r\n          return cb? [], 0\r\n        args = args or {}\r\n        ndx.user = user\r\n        myCb = (err, output) ->\r\n          ndx.user = user\r\n          if err\r\n            resolve []\r\n            return cb? [], 0\r\n          asyncCallback (if isServer then 'serverSelect' else 'select'), \r\n            post: true\r\n            table: table\r\n            objs: output\r\n            isServer: isServer\r\n            user: user\r\n          , ->\r\n            ndx.user = user\r\n            total = output.length\r\n            if args.page or args.pageSize\r\n              args.page = args.page or 1\r\n              args.pageSize = args.pageSize or 10\r\n              output = output.splice (args.page - 1) * args.pageSize, args.pageSize\r\n            if useEncryption\r\n              for obj in output\r\n                obj = decryptObj obj, table\r\n            asyncCallback (if isServer then 'serverSelectTransform' else 'selectTransform'),\r\n              transform: true\r\n              table: table\r\n              objs: output\r\n              isServer: isServer\r\n              user: user\r\n            , ->\r\n              ndx.user = user\r\n              ndx.cache && ndx.cache.set table, args, user,\r\n                output: output\r\n                total: total\r\n              resolve output\r\n              cb? output, total\r\n        collection = database.collection table\r\n        options = {}\r\n        sort = {}\r\n        if args.sort\r\n          if typeof args.sort is 'string'\r\n            sort[args.sort] = if args.sortDir is 'DESC' then -1 else 1\r\n          else\r\n            sort = args.sort\r\n        where = if args.where then args.where else args\r\n        where = convertWhere where\r\n        #if useEncryption\r\n        #  where = encryptWhere where, table\r\n        collection.find where, options\r\n        .sort sort\r\n        .toArray myCb        \r\n    )(ndx.user)\r\nselectOne = (table, args, cb, isServer) ->\r\n  output = await select table, args, null, isServer\r\n  if output and output.length\r\n    return output[0]\r\n  else\r\n    return null\r\n    \r\nmodule.exports =\r\n  config: (config) ->\r\n    for key of config\r\n      keyU = s(key).underscored().value().toUpperCase()\r\n      settings[keyU] = config[key] or config[keyU] or settings[keyU]\r\n    if settings.ENCRYPT_IGNORE\r\n      encryptIgnore = settings.ENCRYPT_IGNORE\r\n    if settings.ENCRYPT_MONGO\r\n      useEncryption = true\r\n    settings.ENCRYPTION_KEY = settings.ENCRYPTION_KEY or process.env.ENCRYPTION_KEY\r\n    @\r\n  start: ->\r\n    if settings.MONGO_URL\r\n      MongoClient.connect settings.MONGO_URL, settings.MONGO_OPTIONS, (err, db) ->\r\n        if err\r\n          throw err\r\n        database = db\r\n        console.log \"ndx-mongo v#{version} ready\"\r\n        syncCallback 'ready', database\r\n    @\r\n  on: (name, callback) ->\r\n    callbacks[name].push callback\r\n    @\r\n  off: (name, callback) ->\r\n    callbacks[name].splice callbacks[name].indexOf(callback), 1\r\n    @\r\n  select: select\r\n  selectOne: selectOne\r\n  count: (table, whereObj, cb) ->\r\n    whereObj = convertWhere whereObj\r\n    collection = database.collection table\r\n    collection.count whereObj, (err, count) ->\r\n      cb? count\r\n  update:  (table, obj, whereObj, cb, isServer) ->\r\n    whereObj = convertWhere whereObj\r\n    cleanObj obj \r\n    ((user) ->\r\n      collection = database.collection table\r\n      collection.find whereObj, {}\r\n      .toArray (err, oldItems) ->\r\n        if not err and oldItems\r\n          ids = []\r\n          async.each oldItems, (oldItem, diffCb) ->\r\n            if useEncryption\r\n              oldItem = decryptObj oldItem, table\r\n            diffs = readDiffs oldItem, unpack(obj)\r\n            newObj = {}\r\n            Object.assign newObj, oldItem\r\n            Object.assign newObj, obj\r\n            asyncCallback (if isServer then 'serverPreUpdate' else 'preUpdate'),\r\n              pre: true\r\n              id: oldItem._id.toString()\r\n              table: table\r\n              where: whereObj\r\n              obj: obj\r\n              oldObj: oldItem\r\n              newObj: newObj\r\n              changes: diffs\r\n              user: user\r\n            , (result) ->\r\n              if not result\r\n                return diffCb()\r\n              ndx.cache && ndx.cache.reset table\r\n              ndx.user = user\r\n              id =oldItem._id.toString()\r\n              delete obj._id\r\n              collection.updateOne\r\n                _id: oldItem._id\r\n              ,\r\n                $set: if useEncryption then encryptObj(obj, table) else obj\r\n              , (err, result) ->\r\n                ndx.user = user\r\n                asyncCallback (if isServer then 'serverUpdate' else 'update'),\r\n                  post: true\r\n                  id: id\r\n                  table: table\r\n                  obj: obj\r\n                  oldObj: oldItem\r\n                  newObj: newObj\r\n                  changes: diffs\r\n                  user: user\r\n                  isServer: isServer\r\n                ids.push result.insertedId\r\n                diffCb()\r\n          , ->\r\n            cb? err,\r\n              op: 'update'\r\n              id: ids\r\n        else\r\n          cb? 'nothing to update',\r\n            op: 'update'\r\n            id: null      \r\n    )(ndx.user)\r\n  insert: (table, obj, cb, isServer) ->\r\n    cleanObj obj\r\n    ((user) ->\r\n      ndx.user = user\r\n      asyncCallback (if isServer then 'serverPreInsert' else 'preInsert'),\r\n        pre: true\r\n        table: table\r\n        obj: obj\r\n        user: user\r\n      , (result) ->\r\n        if not result\r\n          return cb? []\r\n        ndx.cache && ndx.cache.reset table\r\n        ndx.user = user\r\n        collection = database.collection table\r\n        if obj._id and Object.prototype.toString.call(obj._id) is '[object String]'\r\n          obj._id = new ObjectId(obj._id)\r\n        if Object.prototype.toString.call(obj) is '[object Array]'\r\n          async.each obj, (o, callback) ->\r\n            collection.insertOne (if useEncryption then encryptObj(o, table) else o)\r\n            , (err, r) ->\r\n              ndx.user = user\r\n              o._id = r.insertedId\r\n              asyncCallback (if isServer then 'serverInsert' else 'insert'),\r\n                post: true\r\n                id: o._id\r\n                table: table\r\n                obj: o\r\n                user: user\r\n                isServer: isServer\r\n              cb? err, \r\n                op: 'insert'\r\n                id: r.insertedId\r\n              callback()\r\n        else\r\n          collection.insertOne (if useEncryption then encryptObj(obj, table) else obj)\r\n          , (err, r) ->\r\n            ndx.user = user\r\n            obj._id = r.insertedId\r\n            asyncCallback (if isServer then 'serverInsert' else 'insert'),\r\n              post: true\r\n              id: obj._id\r\n              table: table\r\n              obj: obj\r\n              user: user\r\n              isServer: isServer\r\n            cb? err, \r\n              op: 'insert'\r\n              id: r.insertedId\r\n    )(ndx.user)\r\n  upsert: (table, obj, whereObj, cb, isServer) ->\r\n    where = convertWhere JSON.parse JSON.stringify whereObj\r\n    if (not whereObj or JSON.stringify(whereObj) is '{}') and obj._id\r\n      whereObj = {}\r\n      whereObj._id = obj._id.toString()\r\n      where = convertWhere JSON.parse JSON.stringify whereObj\r\n    ((user) =>\r\n      if not whereObj or JSON.stringify(whereObj) is '{}'\r\n        return @insert table, obj, cb, isServer\r\n      collection = database.collection table\r\n      collection.find where\r\n      .toArray (err, test) =>\r\n        if test and test.length\r\n          @update table, obj, whereObj, cb, isServer\r\n        else\r\n          @insert table, obj, cb, isServer\r\n      ###\r\n      if JSON.stringify(whereObj) isnt '{}'\r\n      ###\r\n    )(ndx.user)\r\n  delete: (table, whereObj, cb, isServer) ->\r\n    whereObj = convertWhere whereObj\r\n    if useEncryption\r\n      where = encryptWhere where, table\r\n    ((user) ->\r\n      asyncCallback (if isServer then 'serverPreDelete' else 'preDelete'),\r\n        pre: true\r\n        table: table\r\n        where: whereObj\r\n        user: user\r\n      , (result) ->\r\n        if not result\r\n          cb? []\r\n        ndx.cache && ndx.cache.reset table\r\n        ndx.user = user\r\n        collection = database.collection table\r\n        collection.deleteMany whereObj, null, ->\r\n          asyncCallback (if isServer then 'serverDelete' else 'delete'), \r\n            post: true\r\n            table: table\r\n            user: ndx.user\r\n            isServer: isServer\r\n          cb?()\r\n    )(ndx.user) \r\n  maintenanceOn: ->\r\n    maintenanceMode = true\r\n  maintenanceOff: ->\r\n    maintenanceMode = false\r\n  version: ->\r\n    version\r\n  maintenance: ->\r\n    maintenanceMode\r\n  setNdx: (_ndx) ->\r\n    ndx = _ndx\r\n    @\r\n  makeSlug: (table, template, data, cb) ->\r\n    slug = s(ndx.fillTemplate(template, data)).prune(30, '').slugify().value()\r\n    if data.slug and data.slug.indexOf(slug) is 0\r\n      return cb true\r\n    testSlug = slug\r\n    outSlug = null\r\n    async.whilst ->\r\n      outSlug is null\r\n    , (callback) =>\r\n      @select table,\r\n        slug: testSlug\r\n      , (results) ->\r\n        if results and results.length\r\n          testSlug = slug + '-' + Math.floor(Math.random() * 9999)\r\n        else\r\n          outSlug = testSlug\r\n        callback null, outSlug\r\n      , true\r\n    , (err, slug) ->\r\n      data.slug = slug\r\n      cb? true\r\n  fieldFromTemplate: (template, data, fieldName) ->\r\n    data[fieldName] = ndx.fillTemplate template, data\r\n  decryptObj: decryptObj\r\n  stats: (cb) ->\r\n    database.command\r\n      dbStats: 1\r\n    , (err, result) ->\r\n      cb err, result\r\n  cacheSize: ->\r\n    0"
  ]
}